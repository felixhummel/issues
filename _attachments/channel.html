<!DOCTYPE html>
<html>
  <head>
    <title>Welcome to Toast</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <link media="only screen and (max-device-width: 480px)" 
        href="style/iphone.css" type="text/css" rel="stylesheet" />      
  </head>
  <body>
    <h1>Toast</h1>
    <div id="sidebar">
      <p>Go to the index <a href="index.html">to make new channels or find others.</a> Download the <a href="http://github.com/jchris/toast">Toast source code at Github.</a></p>
      <p><strong>Toast</strong> is 100% pure <a href="http://couchdb.org">CouchDB</a>, deployed to an old Mac Mini in an overheated colo closet. You are encouraged to install CouchDB (0.10.0-dev) on your computer and run your own Toast instances. You can even use replication to sync with other people's chats in near real-time.</p>
      <h4>Learn About CouchDB</h4>
      <p><a href="http://my.safaribooksonline.com/9780596158156?cid=orm-cat-readnow-9780596158156">O'Reilly</a> is releasing a book on CouchDB. <a href="http://jan.prima.de/~jan/plok/">Jan</a>, <a href="http://tumbolia.org/nslater">Noah</a> and <a href="http://jchrisa.net">myself</a> are the authors. The book is released under Creative Commons and <a href="http://books.couchdb.org/relax/">available for free on the web</a>.</p>
      <p>There is also a <a href="http://manning.com/chandler/">CouchDB book being released by Manning, written by Chris Chandler.</a></p>
      <h4>About CouchApps:</h4>
      <div id="slideplayer"></div>
      <h4>Get Involved:</h4>
      <p>To get involved in the p2p web, join the <a href="http://groups.google.com/group/couchapp">CouchApp Mailing List</a>. Also please replicate this database to your local instance of CouchDB, modify the application, pass it along, and show your friends. :)</p>
      <p>Or if you're interested in improving or customizing <strong>Toast</strong>, join the <a href="http://jchrisa.net/toast/_design/toast/channel.html#Toasting">Toasting</a> channel.</p>
    </div>
    <div id="chat">
      <form id="new_message" action="#">
        <p><label for="message">Message</label> <input type="text" name="message" value="" id="message" size=90 autocomplete="off">
        </p>
        <p><label for="author-name">Name</label>
          <input type="text" name="author-name" value="" id="author-name">
          <label for="author-email">Email (<em>for <a href="http://gravatar.com">Gravatar</a></em>)</label>
          <input type="text" name="author-email" value="" id="author-email">
          <label for="author-url">URL</label> <input type="text" name="author-url" value="" id="author-url">
          <input type="submit" value="Go &rarr;">
        </p>
      </form>
      <ul id="messages"></ul>
    </div>
  </body>
  <script src="/_utils/script/json2.js"></script>
  <script src="/_utils/script/jquery.js"></script>
  <script src="/_utils/script/jquery.couch.js"></script>
  <script src="/_utils/script/jquery.cookies.js"></script>
  <script src="vendor/couchapp/jquery.couchapp.js"></script>
  <script src="app.js"></script>
  <script type="text/javascript" charset="utf-8">
  var c_xhr;
    $.CouchApp(function(app) {
      function linkify(body, term) {
        return body.replace(/https?\:\/\/\S+/g,function(a) {
          return '<a target="_blank" href="'+a+'">'+a+'</a>';
        }).replace(/\@([\w\-]+)/g,function(user,name) {
          return '<a target="_blank" href="http://twitter.com/'+name+'">'+user+'</a>';
        }).replace(/\#([\w\-]+)/g,function(word,term) {
          return '<a target="_blank" href="http://search.twitter.com/search?q='+encodeURIComponent(term)+'">'+word+'</a>';
        });
      };
      
      var cname = unescape(document.location.hash.replace(/^#/,''));
      $('h1').text('Toast - ' + cname);
      function refreshView() {
        app.view("channels",{
          reduce: false, 
          startkey : [cname,{}],
          endkey : [cname],
          descending: true,
          limit : 25,
          success: function(json) {
          $("#messages").html(json.rows.map(function(row) {
            var m = row.value;
            return '<li>'
              + '<img class="gravatar" src="http://www.gravatar.com/avatar/'+row.value.author.gravatar+'.jpg?s=40&d=identicon"/><span class="say"><strong>'
              + (m.author.url ? 
                '<a href="'+
                escapeHTML(m.author.url) 
                +'">'+
                m.author.name
                +'</a>'
                : m.author.name)
              + "</strong>: "
              + linkify(m.body)
              + '</span> <br/><a class="perma" href="'+app.showPath('toast',row.id)+'">perma</a> <span class="date">' +( m.date || '') + '</span><br class="clear"/></li>';
          }).join(''));
        }});
      };
      $("#author-name").val($.cookies.get("name"));
      $("#author-email").val($.cookies.get("email"));
      var authorRand =  $.cookies.get("rand") || Math.random().toString();
      $("#author-url").val($.cookies.get("url"));
      $("#new_message").submit(function() {
        var name, email, url, body;
        name = $("#author-name").val();
        email = $("#author-email").val();
        url = $("#author-url").val();
        $.cookies.set("name", name);
        $.cookies.set("email", email);
        $.cookies.set("url", url);
        $.cookies.set("rand", authorRand);
        body = $("#message").val();
        if (body) {
          var message = {
            author: {
              name : name,
              email :(email||authorRand),
              url :url
            },
            date : new Date(),
            body : body
          };
          app.db.saveDoc({channel:cname,message:message});
          $("#message").val('');
        }
        return false;
      });
      // this is where we hang on the continuous _changes api
      // get the raw xhr
      refreshView();
      app.db.info({success: function(json) {
        c_xhr = jQuery.ajaxSettings.xhr();
        c_xhr.open("GET", app.db.uri+"_changes?continuous=true&since="+json.update_seq, true);
        c_xhr.send("");
        c_xhr.onreadystatechange = function() {
          refreshView();
        };        
      }})
      
      $('#slideplayer')[0].innerHTML = '<div style="width:325px;height:255px;text-align:left" id="__ss_1357222"><a style="font:14px Helvetica,Arial,Sans-serif;display:block;margin:12px 0 3px 0;text-decoration:underline;" href="http://www.slideshare.net/jchrisa/couchdb-to-the-edge?type=powerpoint" title="CouchDB To The Edge">CouchDB To The Edge</a><object style="margin:0px" width="325" height="255"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=to-the-edge-090428093711-phpapp02&rel=0&stripped_title=couchdb-to-the-edge" /><param name="allowFullScreen" value="true"/><param name="allowScriptAccess" value="always"/><embed src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=to-the-edge-090428093711-phpapp02&rel=0&stripped_title=couchdb-to-the-edge" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="325" height="255"></embed></object></div>';

    });
  </script>
</html>
