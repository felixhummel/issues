<!DOCTYPE html>
<html>
  <head>
    <title>Welcome to Toast</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <link media="only screen and (max-device-width: 480px)" 
        href="style/iphone.css" type="text/css" rel="stylesheet" />      
  </head>
  <body>
    <h1>Toast</h1>

    <div id="chat">
      <div id="userCtx"></div>
      <form id="new_message" action="#">
        <p><label for="message">Message <input type="text" name="message" value="" id="message" size=90 autocomplete="off"></label>
        </p>
        <p>
          <label for="nickname">Nickname <input type="text" name="nickname" value=""></label>
          <label for="email">Email (<em>for <a href="http://gravatar.com">Gravatar</a></em>)
          <input type="text" name="email" value=""></label>
          <label for="url">URL<input type="text" name="url" value=""></label> 
          <input type="submit" value="Go &rarr;">
        </p>
        
        <label for="author-name">Nickname</label>
          <input type="text" name="author-name" value="" id="author-name">
          <label for="author-email">Email (<em>for <a href="http://gravatar.com">Gravatar</a></em>)</label>
          <input type="text" name="author-email" value="" id="author-email">
          <label for="author-url">URL</label> <input type="text" name="author-url" value="" id="author-url">
          <input type="submit" value="Go &rarr;">
      </form>
      <ul id="messages"></ul>
    </div>
  </body>
  <script src="/_utils/script/json2.js"></script>
  <script src="/_utils/script/jquery.js"></script>
  <script src="/_utils/script/jquery.couch.js"></script>
  <script src="/_utils/script/sha1.js"></script>
  <script src="vendor/couchapp/jquery.couch.app.js"></script>
  <script src="vendor/couchapp/jquery.evently.js"></script>
  <script src="vendor/couchapp/jquery.mustache.js"></script>
  <script src="vendor/couchapp/jquery.couch.app.account.js"></script>
  <script src="html.js"></script>
  <script src="app.js"></script>
  <script type="text/javascript" charset="utf-8">
  var c_xhr;
    $.couch.app(function(app) {
      
      // we should look up the users' login info first and require them to login before posting
      
      // app.login.widget('#userCtx', {
      //   loggedIn : function() {
      //     alert("this will be called when the user is logged in")
      //   }
      // });
      
      $.couch.app.account.loggedIn.template = 'Toasty welcome, <a target="_new" href="/_utils/document.html?{{auth_db}}/org.couchdb.user%3A{{uri_name}}">{{name}}</a>! <a href="#logout">Logout?</a>';

      $("#userCtx").evently($.couch.app.account)
      $("#userCtx").trigger("refresh");
      
      
      var cname = unescape(document.location.hash.replace(/^#/,''));
      joinChannel(app, cname);
      var newname=cname;
      setInterval(function() {
        newname = unescape(document.location.hash.replace(/^#/,''));
        if (newname != cname) {
          joinChannel(app, newname);
          cname=newname
        }
      }, 500);

    });
  </script>
</html>
