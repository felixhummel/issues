<!DOCTYPE html>
<html>
  <head>
    <title>Issues - Edit</title>
    <link rel="stylesheet" href="css/main.css" type="text/css">
  </head>
  <body>
    <p id="msg" stlye="display: none;"></p>
    <div id="thisDoc" style="float: left;">
      <h1>Issue {{id}}, rev <span id="rev">{{rev}}</span></h1>
      <h2>Created at</h2>
      <p>{{created_at}}</p>
      <h2>Status:</h2>
      <p>
        <select id="status">
          {{#statuses}}
          <option>{{option}}</option>
          {{/statuses}}
        </select>
      </p>
      <h2>Text:</h2>
      <textarea id="text">{{text}}</textarea>
      <div id="options">
        <h2>Options</h2>
        <button id="ok">Submit</button>
        <button id="delete">Delete</button>
      </div>
    </div>
    <div id="otherDoc" style="float: right; display: none">
    </div>
  </body>
  {{>scripts}}
  <script type="text/javascript" charset="utf-8">
    $.couch.app(function(app) {
      var path = app.require("vendor/couchapp/lib/path").init(app.req);
      var doc = {{{doc}}},  // parse doc from string
        otherDoc = {}, // conflicting document
        userChangedStuff = false,  // user changed some input field
        saveOK = function(resp) {
          $("#rev").text(prettyRev(resp.rev)); 
        }
        prettyRev = function(r) {
          return r.split && r.split('-')[0] || 'undefined';
        },
        beforeMerge = function() {
          $("#options").hide();
        }
        afterMerge = function() {
          window.location = window.location;
          $("#options").show();
        },
        conflictHandler = function(status, error, reason) {
          if (error == 'conflict') {
            beforeMerge();
            // get other doc, display
            app.db.openDoc(doc._id, {
              success: function(d) {
                otherDoc = d;
                // xxx refactor: use partial template to show doc
                $('#otherDoc')
                .html(
                  '<h1>Issue '+otherDoc._id+', rev '+prettyRev(otherDoc._rev)+'</h1>'
                  +'<h2>Created at</h2>'
                  +'<p>'+otherDoc.created_at+'</p>'
                  +'<h2>Status:</h2>'
                  +'<select disabled="disabled"><option>'+otherDoc.status+'</select></option>'
                  +'<h2>Text:</h2>'
                  +'<textarea disabled="disabled">'+otherDoc.text+'</textarea>'
                )
                .show();
                $("#thisDoc").prepend('<button id="btnThis">Take this</button>');
                $("#otherDoc").prepend('<button id="btnThat">Take that</button>');
                // click handlers for THIS and OTHER
                $("#btnThis").click(function() {
                  // take revision from other and commit
                  doc._rev = otherDoc._rev;
                  app.db.saveDoc(doc, {
                    success: function(resp) {
                      saveOK(resp);
                    },
                    error: conflictHandler
                  });
                  afterMerge();
                });
                $("#btnThat").click(function() {
                  // could do this ajax style, but reload is sufficient for now
                  afterMerge();
                });
              },
              error: function() {
                alert('Error getting other document');
              }
            });
          } else {
            alert("Error " + reason)
          }
        },
        clearError = function() {
          $("#otherDoc").html('');
        }
      ; // END var
      delete doc._revisions;  // else: update conflict
      $("#delete").click(function() {
        if (confirm("Do you really want to delete this issue?")) {
          app.db.removeDoc(doc, {
            success: function() {
              window.location = path.list('tabular', 'by_date');
            }
          });
        }
      });
      $("#status")
      .val(doc.status)
      .change(function() {
        userChangedStuff = true;
      });
      $("#text")
      .change(function() {
        userChangedStuff = true;
      });
      $("#ok").click(function() {
        doc.status = $("#status").val();
        doc.text = $("#text").val();
        app.db.saveDoc(doc, {
          success: function(resp) {
            saveOK(resp);
          },
          error: conflictHandler
        });
      });
    });
  </script>

</html>
