<!DOCTYPE html>
<html>
  <head>
    <title>Issues - Edit</title>
    <link rel="stylesheet" href="css/main.css" type="text/css">
  </head>
  <body>
    <div id="currentIssue" style="float: left">
      <h1>Issue {{id}}, rev {{rev}}</h1>
      <h2>Created at</h2>
      <p>{{created_at}}</p>
      <h2>Status:</h2>
      <p>
        <select id="status">
          {{#statuses}}
          <option>{{option}}</option>
          {{/statuses}}{{status}}
        </select>
      </p>
      <h2>Text:</h2>
      <p>{{text}}</p>
      <h2>Options</h2>
      <button id="remove">Remove</button>
    </div>
    <div id="otherDoc" style="float: right; display: none">
      <h1>Other</h1>
    </div>
  </body>
  {{>scripts}}
  <script type="text/javascript" charset="utf-8">
    $.couch.app(function(app) {
      var doc = {{{doc}}},  // parse doc from string
        otherDoc = {}, // conflicting document
        sendMsg = function(msg) {
          $('#msg').hide().text(msg).fadeIn();
        },
        conflictHandler = function(status, error, reason) {
          if (error == 'conflict') {
            // get other doc, display
            app.db.openDoc(doc._id, {
              success: function(d) {
                otherDoc = d;
                $.log('got other', otherDoc);
                // xxx refactor: use template to show doc
                $('#otherDoc')
                .html(
                  '<h1>Issue '+otherDoc._id+', rev '+otherDoc._rev.split('-')[0]+'</h1>'
                  +'<h2>Created at</h2>'
                  +'<p>'+otherDoc.created_at+'</p>'
                  +'<h2>Status:</h2>'
                  +'<p>'+otherDoc.status+'</p>'
                  +'<h2>Text:</h2>'
                  +'<p>'+otherDoc.text+'</p>'
                )
                .show();
              },
              error: function() {
                alert('Error getting other document');
              }
            });
          } else {
            alert("Error " + reason)
          }
        },
        clearError = function() {
          $("#otherDoc").hide();
        }
      ; // END var
      delete doc._revisions;  // else: update conflict
      $("#remove").click(function() {
        $.log('remove clicked', doc);
      });
      $("#status")
      .val(doc.status)
      .change(function() {
        doc.status = $(this).val();
        app.db.saveDoc(doc, {
          success: function(resp) {
            sendMsg('Saved rev '+resp.rev);
          },
          error: conflictHandler
        });
      });
      conflictHandler(1,'conflict');  // xxx
    });
  </script>

</html>
