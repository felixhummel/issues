<!DOCTYPE html>
<html>
<head>
  <title>Issues - Edit</title>
  <link rel="stylesheet" href="css/main.css" type="text/css">
</head>
<body>
  <div id="msg"></div>
  <div id="thisDoc" style="float: left;"> </div>
  <div id="otherDoc" style="float: right"> </div>
</body>
{{>scripts}}
<script type="text/javascript" charset="utf-8">
  $.couch.app(function(app) {
    var path = app.require("vendor/couchapp/lib/path").init(app.req);
    var Mustache = app.require("lib/mustache");
    var currentDoc = {{{doc}}},  // parse doc from string
      otherDoc = {}, // conflicting document
      updateCurrentDocFromUserInput = function(parent_div) {
        currentDoc.status = $(".status", parent_div).val();
        currentDoc.text = $(".text", parent_div).val();
      },
      renderIssue = function(doc, element, with_options) {
        $.log('render', doc, element, with_options);
        var data = {
          created_at: doc.created_at,
          status: doc.status,
          id: doc._id,
          text: doc.text,
          rev: doc._rev.split('-')[0],
          statuses: [
            { option: 'open' },
            { option: 'closed' }
          ]
        };
        $(element).html(
          Mustache.to_html(app.ddoc.templates.partials.issue, data)
        );
        $('option:contains('+doc.status+')', element).attr('selected','selected');
        if (with_options) {
          $(element).append(Mustache.to_html(app.ddoc.templates.partials.options));
        }
      },
      renderCurrentDoc = function() {
        renderIssue(currentDoc, '#thisDoc', true);
        $("#ok").click(function() {
          updateCurrentDocFromUserInput($("#thisDoc"));
          saveCurrentDoc();
        });
      },
      prettyRevision = function(r) {
        return r.split && r.split('-')[0] || 'undefined';
      },
      saveCurrentDoc = function() {
        app.db.saveDoc(currentDoc, {
          success: function(resp) {
            $("#rev").text(prettyRevision(resp.rev)); 
          },
          error: onConflict
        });
      },
      beforeMerge = function() {
        $("#options").hide();
      }
      afterMerge = function() {
        renderCurrentDoc();
        $("#options").show();
        $("#otherDoc").empty();
      },
      onConflict = function(status, error, reason) {
        if (error == 'conflict') {
          beforeMerge();
          // get other doc, display
          app.db.openDoc(currentDoc._id, {
            success: function(otherDoc) {
              renderIssue(currentDoc, '#thisDoc');
              renderIssue(otherDoc, '#otherDoc');
              $("#thisDoc").prepend('<button id="btnThis">Take this</button>');
              $("#otherDoc").prepend('<button id="btnThat">Take that</button>');
              // click handlers for THIS and OTHER
              $("#btnThis").click(function() {
                // take revision from otherDoc and save it
                currentDoc._rev = otherDoc._rev;
                updateCurrentDocFromUserInput($("#thisDoc"));
                saveCurrentDoc();
                afterMerge();
              });
              $("#btnThat").click(function() {
                // tries to save otherDoc
                currentDoc = otherDoc;
                updateCurrentDocFromUserInput($("#otherDoc"));
                // if yet another commit has been made we will recurse
                saveCurrentDoc();
                afterMerge();
              });
            },
            error: function() {
              alert('Error getting other document');
            }
          });
        } else {
          alert("Error " + reason)
        }
      }
    ; // END var
    delete currentDoc._revisions;  // else: update conflict
    $("#delete").click(function() {
      if (confirm("Do you really want to delete this issue?") === true) {
        app.db.removeDoc(currentDoc, {
          success: function() {
            window.location = path.list('tabular', 'by_date');
          }
        });
      }
    });
    renderCurrentDoc();
  });
  </script>

</html>
